@using Kendo.Mvc.UI
@model Magazin.Models.DialogViewModel
@{
    string wrapId = "wrp_" + Guid.NewGuid().ToString("N");
    string toolbarName = "tlbr_" + Guid.NewGuid().ToString("N");
    string gridId = "grid_" + Guid.NewGuid().ToString("N");
}

<div id="@wrapId">
    <div>
        @(Html.Kendo().ToolBar()
        .Name(toolbarName)
        .Items(toolbar =>
        {
            toolbar.Add().Type(CommandType.ButtonGroup).Buttons(btns =>
            {

                btns.Add().Text("Добавить").ShowText(ShowIn.Overflow).SpriteCssClass("mdi mdi-plus").HtmlAttributes(new { title = "Создать", data_action = "Add" });
                btns.Add().Text("Редактировать").ShowText(ShowIn.Overflow).SpriteCssClass("mdi mdi-pencil").HtmlAttributes(new { title = "Редактировать", data_action = "Edit" });
                btns.Add().Text("Удалить").ShowText(ShowIn.Overflow).SpriteCssClass("mdi mdi-close").HtmlAttributes(new { title = "Удалить", data_action = "Delete" });
            });
        })
        .Events(e =>
        {
            e.Click(gridId + ".onToolbarClick");
        })
        )
    </div>

    <div>
        @(Html.Kendo().Grid<Data.Entities.Product>()
              .Name(gridId)
              .Pageable()
              .AutoBind(false)
              .Scrollable()
              .Selectable(s => s.Mode(GridSelectionMode.Single).Type(GridSelectionType.Row).Enabled(true))
              .Columns(c =>
              {
                  c.Bound(p => p.Title).Title("Наименование");
                  c.Bound(p => p.Decimal).Title("Цена");
              })
              .DataSource(ds => ds
                  .Ajax()
                  .Read(read => read.Action("GetProducts", "Product"))
                  .PageSize(15)
              ))
    </div>
</div>


<script>
    var dialogControl = window['@Model.DialogId'];
    window['@gridId'] = new GridControl('@gridId', "productGrid");

    (function () {
        
        var productsControl = window['@gridId'];
        dialogControl.addControl(productsControl);

        productsControl.createProduct = function () {

        };

        productsControl.deleteProduct = function () {

        };
        productsControl.editProduct = function () {
            var entity = productsControl.getSelectedItem();

            var params = {
                title: 'Продукт',                
                contentUrl: "@Url.Action("EditProduct", "Product")"
            };


            var wid = "dwajdklwjio2p3p3i";

            $('body').append('<div id="' + wid + '"></div>');

            var $w = $('#' + wid);

            $w.kendoWindow({
                width: 100,
                height: 100,
                content: params.contentUrl,
                title: params.title
            });

            //var $window = UiApi.getModalWindow(params);           
            
            kendo.bind($w, entity);

            $w.data('kendoWindow').center().open();

            entity.set('Title', 'dwadhwal dhwui ahduio wa');

        };

        productsControl.onControlFire = function (e) {
            switch (e.sender.desc) {
                case "categories":
                    {
                        switch (e.event) {
                            case "change":
                                {
                                    productsControl.changeCategory(e.data);
                                    break;
                                }
                        }
                        break;
                    }
            }
        };

        productsControl.onToolbarClick = function (e) {
            e.preventDefault();
            var action = e.target.attr('data-action');            
            switch (action) {
                case "Add":
                    {
                        window['@gridId'].createProduct();
                        break;
                    }
                case "Delete":
                    {
                        window['@gridId'].deleteProduct();
                        break;
                    }
                case "Edit":
                    {
                        window['@gridId'].editProduct();
                        break;
                    }
                default:
            }
        }
    })();

    $(function () {
        var $toolbar = $('#@toolbarName');
        $toolbar.find(".k-sprite").removeClass("k-sprite");
    });

</script>